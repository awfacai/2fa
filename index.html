<script>
    new Vue({
        el: "#app",
        data() {
            return {
                totp: null,
                secret: "JBSWY3DPEHPK3PXP",
                period: 30,
                code: "",
                seconds: "",
                timerData: null,
                digits: 6,
                algorithm: "SHA1",
                showSetting: false,
                secretError: "",
                currentUrl: window.location.origin + window.location.pathname,
            };
        },
        created() {
            const urlParams = new URLSearchParams(window.location.search);
            const secret = urlParams.get("code");
            if (secret) {
                this.secret = secret;
                this.$nextTick(() => {
                    this.$message.success("已从URL参数中获取密钥");
                });
            }
            this.initTotp();
        },
        computed: {
            getPress() {
                let press = (this.seconds / this.period) * 100;
                return "width:" + (press > 100 ? 100 : press) + "%";
            },
        },
        methods: {
            // 【新增方法】用于清理密钥字符串
            cleanSecret(s) {
                if (!s) return "";
                // 1. 移除所有空格和连字符 (常见的密钥分隔符)
                let cleaned = s.replace(/[\s-]/g, "");
                // 2. 转换为大写 (Base32不区分大小写，但规范是大写)
                cleaned = cleaned.toUpperCase();
                
                // 3. 尝试替换 Base32 模糊字符 (例如 0/O, 1/L/I)
                // 仅在密钥因非标准字符报错时可能需要，这里先不激进替换
                // cleaned = cleaned.replace(/0/g, 'O').replace(/1/g, 'L').replace(/8/g, '').replace(/9/g, '');

                return cleaned;
            },
            initTotp() {
                this.secretError = "";
                this.code = "";
                this.seconds = "";
                
                const rawSecret = this.secret;
                // 使用清理后的密钥
                const cleanedSecret = this.cleanSecret(rawSecret); 

                if (!cleanedSecret) {
                    this.secretError = "请输入密钥";
                    return;
                }

                try {
                    // 尝试使用清理后的密钥初始化 TOTP
                    let totp = new OTPAuth.TOTP({
                        issuer: "TOTP Generator",
                        label: "User",
                        algorithm: this.algorithm,
                        digits: parseInt(this.digits) || 6,
                        period: parseInt(this.period) || 30,
                        secret: cleanedSecret, // 使用清理后的密钥
                    });

                    this.totp = totp;
                    this.code = totp.generate();
                    this.seconds = totp.period - (Math.floor(Date.now() / 1000) % totp.period);
                    this.timer();
                } catch (error) {
                    // 如果初始化失败，通常是 Base32 编码问题
                    console.error("TOTP生成错误:", error);
                    
                    // 检查是否为 Base32 格式错误
                    const isBase32Error = error.message && 
                                          (error.message.includes("Invalid character") || 
                                           error.message.includes("Base32") || 
                                           error.message.includes("Length"));

                    if (isBase32Error) {
                        this.secretError = "密钥格式错误。已自动清理空格，请确认输入的字符符合 Base32 编码（A-Z 和 2-7）。";
                    } else {
                        this.secretError = "生成 TOTP 时发生未知错误。";
                    }
                }
            },
            timer() {
                clearInterval(this.timerData);
                this.timerData = setInterval(() => {
                    if (this.seconds <= 1) {
                        this.initTotp();
                        return;
                    }
                    this.seconds -= 1;
                }, 1000);
            },
            copyUrlExample() {
                const exampleUrl = `${this.currentUrl}?code=YOUR_SECRET_KEY`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard
                        .writeText(exampleUrl)
                        .then(() => {
                            this.$message.success("URL示例已复制到剪贴板");
                        })
                        .catch(() => {
                            this.fallbackCopy(exampleUrl);
                        });
                } else {
                    this.fallbackCopy(exampleUrl);
                }
            },
            fallbackCopy(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand("copy");
                    this.$message.success("URL示例已复制到剪贴板");
                } catch (err) {
                    this.$message.warning("复制失败，请手动复制");
                }

                document.body.removeChild(textArea);
            },
        },
        beforeDestroy() {
            if (this.timerData) {
                clearInterval(this.timerData);
            }
        },
    });
</script>
